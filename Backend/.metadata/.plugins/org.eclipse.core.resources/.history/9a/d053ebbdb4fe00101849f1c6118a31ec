package com.sam.services;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;

import com.sam.dto.ChatMessageDTO;
import com.sam.dto.ChatResponseDTO;
import com.sam.models.*;
import com.sam.repositories.*;

@Service
public class ChatService {

    @Autowired
    private ConversationRepository conversationRepository;

    @Autowired
    private MessageRepository messageRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private SimpMessagingTemplate messagingTemplate;

    public void processMessage(ChatMessageDTO dto) {

        User sender = userRepository.findById(dto.getSenderId())
                .orElseThrow(() -> new RuntimeException("Sender not found"));

        User receiver = userRepository.findById(dto.getReceiverId())
                .orElseThrow(() -> new RuntimeException("Receiver not found"));

        // Buyer = message initiator (safe assumption)
        User buyer = sender;
        User owner = receiver;

        Conversation conversation = conversationRepository
                .findByListingTypeAndListingIdAndBuyer_IdAndOwner_Id(
                        dto.getListingType(),
                        dto.getListingId(),
                        buyer.getId(),
                        owner.getId())
                .orElseGet(() -> {
                    Conversation c = new Conversation();
                    c.setListingType(dto.getListingType());
                    c.setListingId(dto.getListingId());
                    c.setBuyer(buyer);
                    c.setOwner(owner);
                    return conversationRepository.save(c);
                });

        Message msg = new Message();
        msg.setConversation(conversation);
        msg.setSender(sender);
        msg.setContent(dto.getMessage());

        Message saved = messageRepository.save(msg);

        ChatResponseDTO response = new ChatResponseDTO(
                conversation.getId(),
                saved.getId(),
                sender.getId(),
                sender.getName(),
                saved.getContent(),
                saved.getSentAt()
        );

        // ðŸ”¥ Real-time push
        messagingTemplate.convertAndSend(
                "/topic/chat/" + conversation.getId(),
                response
        );
    }
}
